---
title: "WHO COVID Data"
author: "Pablo Busch, 918913603"
date: "March 2022"
output:
  html_document:
    df_print: paged
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 4
    toc_float: yes
---
```{r global_options, include=FALSE}
# knitr::opts_chunk$set(fig.pos = 'H')
# knitr::opts_chunk$set(fig.pos = 'H', message=F, echo = T, warning=F)
knitr::opts_chunk$set(fig.pos = 'H', message=F, echo = F, warning=F)
```

```{r}
# libraries
library(tidyverse) # data manipulation
library(scales) 
library(lubridate) #time format
library(gridExtra) # plot manipulation
library(skimr) # summary statistics
library(flextable) #table format for hhtml
theme_set(theme_bw(16)+theme(panel.grid.major = element_blank()))
```

# Roadmap towards final report


**To Do**:

- **Case Fatality Rate (CFR) calculation**: I need to better define my response variable, monthly case fatality rate, and explain clearly how is it calculated in an ongoing pandemic. Do I need to consider any lag time issue? A two week shift in the data, to align cases and deaths for COVID-19 could be a potential workaround.
- **Time series autocorrelation**: I need to better explain and test for time series autocorrelation, as my monthly data is a time series. A potential solution is using the differences between months for each variable.
- **Model correction:** By exaimining the diagnostic plots for the model, it is clear that the distribution of the residuals don't follow a Normal distibution, but rather a right-skewed distribution.
- **Need to conduct sensitivity analysis, with several scenarios**:
  - Remove observations with outliers values for CFR. Threshold could be a monthly value above 10%.
  - Test a model with more categories for vaccination level variable: [0%-10%, 10%-20%, ..., 90%-100%].
  - Fit mixed generalized linear model with countries as a random effects variable.
  - Use bootstrap methods to estimate the confidence intervals for my fitted coefficients.

# Work done since last report:

- - **Model re-definition**: I remove the additional confounding variables for country characteristics (like income, demographics, life expectancy, among others), as my model includes a dummy variable for each country, the differences across countries area already taken care of by this dummy variable.  
- **Better explanation of the model**: 
  - I better explained the model I am fitting, along the reasoning. I decided to fit a generalized linear model using a negative binomial distribution for the outcome variable (CFR measured as death count). The reason is that for count data with over-dispersion a negative-binomial distribution will suit better the data than a Poisson (as the Poisson distribution has the assumption of equality of mean and variance).
  - I fitted the model with CFR as the outcome variable, using an "offset" for the total cases, so each observations is weighted according to the number of cases that they registered for that month. The model also considers a logarithmic transformation on the outcome variable.
  - I included a better explanation of the data used, and total number of observations. Also a more detailed Methods section that explain how I aggregate the data into monthly observations for each country.
  - I explained in the methods that I will fit a model using vaccination level as numerical and another model using vaccination level as a categorical variable (with 4 defined levels). In my results section I already fitted the model with the vaccination categorical variable.
- I increased the matching between my two data sources (WHO and OurWorldinData), to increase the total number of countries included in my analysis.
- I improve the figures in the report, add comments to them and include some tables with descriptive statistics.

*** 

# Abstract 

**Outline**:

- Background: COVID-19 Pandemic and Vaccines
- Key question: differences in case mortality rate for countries with higher vaccination rates
- Data used: WHO and vaccination data
- Results
- Limitations
- Conclusion

# Introduction

Since 2020 the world has been facing a pandemic, caused by the COVID-19. The virus cause an inflammatory respiratory stress on the human body. In the two years of the pandemic, approximately 5 million people have died, and more than 400 million have been infected. Several countries have taken different methods to mitigate the dispersion and impact of the pandemic, such as mobility restrictions (quarantines), social distancing measures, mask enforcement. A year ago (end of 2020) novel vaccines against COVID-19 were developed, which have proven useful to reduce the death rate due to COVID-19. \newline

This report seek to study the effect of vaccines on the COVID-19 case fatality rate (CFR) (deaths/cases). The key question to answer is whether country with higher vaccination rates among their population are associated with lower COVID-19 case fatality rates (CFR). In previous studies COVID-19 vaccines have been associated with lower CFRs (Liang et al. 2021).

# Background 

As an international organization with the mission to improve human health, the World Health Organization (WHO) has been compiling daily country level data for the COVID-19 pandemic. This data is easily accessible to the general public ([link to download](https://covid19.who.int/info)). The data contains COVID-19 daily related cases and deaths for a variety of countries. Here are the resolutions:

- Temporal resolution: Day, from 2020 (January) to 2022 (present)
- Geographical resolution: Country (237 unique) and world region (7 in total)
- Outcome to study:
  + Case Fatality Rate (CFR): Measurement of amount of patients with COVID-19 that died ($CFR=\frac{Deaths}{Cases}$)
  
We are interested in exploring the effect of vaccines on the case fatality rate for COVID-19. Our World in Data is an organization that compiles country level data from multiple sources to make research more easy. They have a made a strong effort to compile a database with the total number of people fully vaccinated (people who received all doses prescribed by the vaccination protocol) by date and country. The vaccination data is available [here](https://ourworldindata.org/covid-vaccinations), with a public [GitHub](https://github.com/owid/covid-19-data/tree/master/public/data/vaccinations). \newline

For this project the variable to evaluate vaccination status was the total people fully vaccinated per 100 people in the country. This metric was chosen for several reasons:

- It is already normalized by total population in each country.
- Only considers people that have completely fulfill the requirements for the vaccine administered, whether is 1 or 2 doses required.
- The vaccine type was not considered in the scope of this analysis, but it is a factor that could be considered in future studies.

# Method

## Statistical Model

The time series data for COVID-19 cases and deaths, and vaccination rates per country was converted to a panel data: that is a cross-sectional ecological study (main observational unit is the monthly variables per country). CFR and vaccination rates were summarized to monthly averages to balance the trade-off between number of observations and accuracy of predictions. A monthly average allow us to have 25 time observations per country, which the time-window captures the effect in each given month. \newline

The model to be analyzed will be a generalized linear model, using panel data (ecological cross-sectional with a time series):

$$
log(Y_{i,t})=\beta_0+\beta_1 (Vaccination \: status)_{i,t}+\beta_2 (Country)_i+\beta_3 (Month)_t+\epsilon_{i,t}
$$

Where:

- i: Index for each specific country
- t: Index of month, 25 in total. January 2020 to January 2022.
- $Y_{i,t}$ is the case fatality rate per country “i” on month "t"
- $\beta_1$ is the effects of each vaccination level on the case fatality rate. Two models will be fitted with different vaccination status variables:
  - Numeric: Average of the percentage of people fully vaccinated for the month.
  - Categorical: The average percentage of people fully vaccinate is classified into 4 groups: [0-25%; 25%-50%; 50%-75%; 75%-100%].
- $\beta_2$ is the specific effect of the pandemic in each country
- $\beta_3$ is the time effect of the pandemic, representing the development of new variants of COVID-19, advances in medicine or treatment or any other variable that may have a time effect on the case fatality rate for COVID-19.
- Other potential confounding variables for each country don't need to be included, as the $\beta_2$ coefficient capture the particularities (or heterogeneity) for each country.

The outcome variable in the model corresponds to number of deaths normalized by total cases of COVID-19 (the case fatality rate). The number of deaths were transformed using a negative binomial distribution with a logarithmic link function, as the negative binomial is a better fit for count data tan the Poisson when there is over-dispersion, as it allows the variance to be different from the mean. Each observation in the model is weighted in the regression using the total number of cases per month, which helps to resolve the issue of differences in size between countries. An analysis of the distribution of the outcome variable and the need for a logarithmic transformation is provided in the Appendix section. \newline

The main hypothesis to test the effect of the vaccination level of each country on the CFR for COVID-19, that is to test $H_0:\beta_2=0$ vs $H_A:\beta_2 \neq 0$.

### Sensitivity analysis

Several scenarios will be conducted to analyze results in more robust way:

- Remove observations with outliers values for CFR. Threshold could be a monthly value above 10%.
- Test a model with more categories for vaccination level variable: [0%-10%, 10%-20%, ..., 90%-100%].
- Fit mixed generalized linear model with countries as a random effects variable.
- Use bootstrap methods to estimate the confidence intervals for my fitted coefficients.


## Data preparation

Both datasets (WHO and OurWorldinData) were merged based in the country name, resulting in a match of 167 countries in total. For these countries we got reliable information on COVID-19 cases and deaths, and vaccination status for a given number of months, that may differ according to the start date of vaccination campaigns in each location.\newline

To improve the estimation and robustness of the analysis, the CFR was estimated for each country only in the months in which there were at least 100 cases and more than 10 deaths.

# Results

```{r}
# COVID-19 Data -----
# load WHO COVID-19 data
covid <- read_csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")

# Data wrangling (preparation for analysis)
# filter to remove March 2022
covid <- covid %>% filter(Date_reported<"2022-03-01") 

## Create time factor variable, splitting years in half
halfYear_levels <- c("2020-1","2020-2","2021-1",
                     "2021-2","2022-1")
month_levels <- c("2020-1","2020-2","2020-3","2020-4","2020-5",
                  "2020-6","2020-7","2020-8","2020-9","2020-10",
                  "2020-11","2020-12","2021-1","2021-2","2021-3",
                  "2021-4","2021-5","2021-6","2021-7","2021-8",
                  "2021-9","2021-10","2021-11","2021-12",
                  "2022-1","2022-2")
covid <- covid %>%  
  mutate(period=case_when(
    Date_reported < as.Date("2020-07-01") ~ "2020-1",
    Date_reported < as.Date("2021-01-01") ~ "2020-2",
    Date_reported < as.Date("2021-07-01") ~ "2021-1",
    Date_reported < as.Date("2022-01-01") ~ "2021-2",
    Date_reported < as.Date("2022-07-01") ~ "2022-1",
    T ~ "other") %>% factor(levels=halfYear_levels),
    month=paste(year(Date_reported),month(Date_reported),sep="-") %>% 
      factor(levels =month_levels))

# clean data: remove negative cases and deaths
covid <- covid %>% 
  filter(New_cases>=0 & New_deaths>=0)

## need to summarize COVID data to periods of time: MONTHS
covid_period <- covid %>% 
  group_by(WHO_region,Country,month) %>% 
  summarise(cases=sum(New_cases),
            deaths=sum(New_deaths)) %>% ungroup() %>% 
  filter(cases>99 & deaths>9) %>%  # filter to remove unreliable periods
  mutate(cfr=deaths/cases)  # we calculate CFR for each given month

# VACCINATION DATA -----
## Load vaccination data
vaccination <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv")

# Filter to remove March 2022
vaccination <- vaccination %>% 
  filter(date<"2022-03-01")

# We summarized vaccination data based on the a time period: MONTH
## Create time factor variable, splitting years in half
vaccination <- vaccination %>% 
  mutate(period=case_when(
    date < as.Date("2020-07-01") ~ "2020-1",
    date < as.Date("2021-01-01") ~ "2020-2",
    date < as.Date("2021-07-01") ~ "2021-1",
    date < as.Date("2022-01-01") ~ "2021-2",
    date < as.Date("2022-07-01") ~ "2022-1",
    T ~ "other") %>% factor(levels=halfYear_levels),
    month=paste(year(date),month(date),sep="-") %>% factor(levels=month_levels))

# take the average over the period: NA is 0
vaccination_period <- vaccination %>% 
  mutate(vaccinated=replace_na(people_fully_vaccinated_per_hundred,0)) %>% 
  group_by(location,month) %>% 
  summarise(vaccinated=mean(vaccinated,na.rm=T)) %>% ungroup() 

# JOIN DATA -----

## Change countries name to increase matching (manually, based on visual inspection)
covid <- covid %>% 
  mutate(Country=case_when(
    Country=="Bolivia (Plurinational State of)" ~ "Bolivia",
    Country=="Bonaire" ~ "Bonaire Sint Eustatius and Saba",
    Country=="Brunei Darussalam" ~ "Brunei",
    Country=="Cabo Verde" ~ "Cape Verde",
    Country=="Côte d’Ivoire" ~ "Cote d'Ivoire",
    # str_detect(Country,"C.te d.Ivoire") ~ "Cote d'Ivoire", 
    Country=="Curaçao" ~ "Curacao",
    # str_detect(Country,"Cura.ao") ~ "Curacao",
    Country=="Democratic Republic of the Congo" ~ "Democratic Republic of Congo",
    Country=="Falkland Islands (Malvinas)" ~ "Falkland Islands",
    Country=="Faroe Islands" ~ "Faeroe Islands",
    Country=="Iran (Islamic Republic of)" ~ "Iran",
    Country=="Kosovo[1]" ~ "Kosovo",
    Country=="Lao People's Democratic Republic" ~ "Laos",
    Country=="occupied Palestinian territory, including east Jerusalem" ~ "Palestine",
    Country=="Pitcairn Islands" ~ "Pitcairn",
    Country=="Republic of Korea" ~ "South Korea",
    Country=="Republic of Moldova" ~ "Moldova",
    Country=="Russian Federation" ~ "Russia",
    Country=="Sint Maarten" ~ "Sint Maarten (Dutch part)",
    Country=="Syrian Arab Republic" ~ "Syria",
    Country=="The United Kingdom" ~ "United Kingdom",
    Country=="Timor-Leste" ~ "Timor",
    Country=="United Republic of Tanzania" ~ "Tanzania",
    Country=="United States of America" ~ "United States",
    Country=="Venezuela (Bolivarian Republic of)" ~ "Venezuela",
    Country=="Viet Nam" ~ "Vietnam",
    T ~ Country))

# Join countries from both data sources
# countries_covid <- unique(covid$Country)
# countries_vaccine <- unique(vaccination$location)
# 
# countries_vaccine <- data.frame(countries_vaccine=countries_vaccine,
#                              x=1)
# countries_covid <- data.frame(countries_covid=countries_covid,
#                               y=1)

# are the codes similar?
# countries_vaccine %>%
#   left_join(countries_covid,by=c("countries_vaccine"="countries_covid")) %>%
#   pull(y) %>% sum(na.rm=T)
# 215 countries match


# join based on location - I join it to the Vaccination, so I can get months with vaccine information for each country
df <- vaccination_period %>% 
  left_join(covid_period, by=c("location"="Country",
                               "month")) %>% 
  filter(cases>=0 & deaths>=0 & !(is.na(vaccinated)))

## More convenient labels for region
df <- df %>% 
  mutate(region_name=case_when(
    WHO_region=="EMRO" ~ "Eastern Mediterranean",
    WHO_region=="EURO" ~ "Europe",
    WHO_region=="AFRO" ~ "Africa",
    WHO_region=="AMRO" ~ "Americas",
    WHO_region=="WPRO" ~ "Western Pacific",
    WHO_region=="SEARO" ~ "South-East Asia") %>%
      factor(levels=c("Americas","Europe","Eastern Mediterranean",
                      "Western Pacific","South-East Asia","Africa")),
  location=as.factor(location))

# Vaccination level factor variable
df <- df %>% 
  mutate(vaccinated_level=case_when(
    vaccinated<25 ~ "0%-25%",
    vaccinated<50 ~ "25%-50%",
    vaccinated<75 ~ "50%-75%",
    vaccinated<100 ~ "75%-100%",
    T ~"other") %>% factor(levels=c("0%-25%","25%-50%",
                                    "50%-75%","75%-100%"))) 

```


## Descriptive analysis 

### COVID-19

Let's provide some summary statistics for the COVID-19 cases and deaths data.

```{r}
# function to estimate summary statistics:
f.sum <- function(x){
  return(
    data.frame(
     Mean=mean(x,na.rm=T),
     sd=sd(x,na.rm=T),
     Min=min(x,na.rm=T),
     Median=quantile(x,0.5,na.rm=T),
     Max=max(x,na.rm = T)
    )
  )
}

# average number of months per county:
avg_country_month <- df %>% 
  group_by(location) %>% tally()

# Table with summary statistics
rbind(`Number of months per country`=f.sum(avg_country_month$n),
      `COVID-19 Cases per Month`=f.sum(df$cases),
      `COVID-19 Deaths per Month`=f.sum(df$deaths),
      `Case Fatality Rate (CFR) %`=f.sum(df$cfr*100),
      `People Fully Vaccinated per 100 people`=f.sum(df$vaccinated)) %>% 
  rownames_to_column() %>% rename(Metric=rowname) %>% 
  flextable() %>% autofit() %>% 
  colformat_double(digits=2) %>% 
  colformat_double(i=2:3,digits=0) %>% 
  bold(part = "header") %>% 
  set_caption(paste0(
    "Summary Metrics: Monthly observations per country. n = ",nrow(df))) %>% 
  footnote(i=1,j=1,
           as_paragraph(paste0(length(unique(df$location)),
                               " Countries considered")))

rm(avg_country_month)
```

We observe:

- For the 167 countries considered, we have an average number of months with an estimation for the CFR of 10.25. This number will probably be sufficient to draw inferences on the effect of vaccination level on CFR, while controlling for each country characteristics.
- The CFR has a mean value of 2.45%, with a larger variance. More importantly, there are countries with really high CFR.
- We observe also a high dispersion in the vaccination level across observations, with some countries reaching more than 90 people fully vaccinated per 100 people.


```{r}
#### Time series of COVID-19 Cases and deaths
p_region <- df %>% 
  pivot_longer(c(cases,deaths), names_to = "key", values_to = "value") %>% 
  ggplot(aes(month,value))+
  # geom_line()+
  geom_boxplot()+
  facet_wrap(~key,ncol=1,scales = "free_y")+
  labs(x="Date",y="")+
  scale_y_continuous(labels=function(x) format(x, 
                                               big.mark = " ", 
                                               scientific = FALSE),
                     trans = "log10")
# p_region


p_cfr_time <- df %>% 
  ggplot(aes(month,cfr))+
  geom_boxplot()+
   scale_y_continuous(labels = scales::percent,
                      limits = c(0,0.1))+
  labs(x="Date",y="Case Fatality Rate COVID-19 [%]")+
  theme(axis.text.x = element_text(angle =-45,vjust=-0.5))
# p_cfr_time

p_vacc_time <- df %>% 
  ggplot(aes(month,vaccinated))+
  geom_boxplot()+
  labs(x="Date",y="People Fully Vaccinated per 100 people")+
  theme(axis.text.x = element_text(angle =-45,vjust=-0.5))
# p_vacc_time

## combine graphs
# grid.arrange(p_cfr_time,p_vacc_time,ncol=1)
```


#### Case Mortality Rate COVID-19

Our main outcome of interest is the case fatality rate for COVID-19. Let's look at the total case fatality rate for COVID-19 for the entire pandemic period:

```{r}
df %>% 
  filter(WHO_region!="Other") %>% 
  ggplot(aes(region_name,cfr))+
  geom_jitter(alpha=0.5)+
  geom_boxplot(alpha=0.5,outlier.alpha = 0)+
  coord_flip()+
  scale_y_continuous(labels = scales::percent, limits=c(0,0.1))+
  labs(x="WHO Region",y="Case Fatality Rate COVID-19 [%]",
       caption = "Cumulated cases and deaths for the period December 2020 to February 2022 \n Only CFR below 10% are shown")

# percentage above 10%
# sum(nrow(filter(df,cfr>0.1)))/nrow(df)*100
```

We can see that the case fatality rate is around 2% for the majority of the observations gathered, that correspond at monthly rates for each country. We observe variations across each country and across WHO regions, with Europe and Western Pacific with the lowest CFR. \newline

Let's look at the case fatality rate over time:

```{r}
# Time series CFR - NEED TO CONSIDER WEIGHTED AVERAGE
df %>% 
  group_by(month,region_name) %>%
  summarize(cfr=mean(cfr,na.rm=T)) %>%
  ggplot(aes(month,cfr,
             col=region_name,
             group=region_name
             ))+
  geom_line()+
  # geom_boxplot()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.1),
                     # breaks=c(0,0.05,0.1)
                     )+
  theme(axis.text.x = element_text(angle =-45,vjust=-0.5))+
  labs(x="",y="Case Fatality Rate COVID-19 [%]",col="WHO Region")
```

We observe a higher value in the CFR in the early times of the pandemic and a reduction in the most recent times. We also observe important peaks and differences across WHO regions.

### Vaccination Data

The next figure shows the vaccination status for each country at February 2022. We observe important differences in the access to vaccines across WHO regions, and within countries in the same region. For example, Europe present a high vaccination rate, but we observe important differences in the vaccination level of the countries of Europe. The distribution of vaccination levels seems to be two-modal, with some countries with high vaccination and some with really low. \newline

Further analysis is included in the appendix session, which shows a clear bi-modal distribution for every WHO region regarding vaccination level, except for Africa that has only low vaccinated countries.

```{r}
df %>% 
  filter(month=="2022-2") %>% #February 2022 
  ggplot(aes(region_name,vaccinated))+
  geom_jitter(alpha=0.5)+
  geom_boxplot(alpha=0.5,outlier.alpha = 0)+
  coord_flip()+
  labs(x="WHO Region",y="People Fully Vaccinated per 100 people",
       caption = "Vaccination status at February 2022")
```


```{r}
# time series of vaccination - NEED TO CONSIDER WEIGHTED AVERAGE
# df %>% 
#   group_by(month,region_name) %>%
#   summarize(vaccinated=mean(vaccinated,na.rm=T)) %>%
#   ggplot(aes(month,vaccinated,
#              col=region_name,
#              group=region_name
#              ))+
#   geom_line()+
#   # geom_boxplot()+
#   theme(axis.text.x = element_text(angle =-45,vjust=-0.5))+
#   labs(x="",y="People Fully Vaccinated per 100 people",col="WHO Region")
```



### CFR vs Vaccination Rates

Let's make a comparison per period of time of percentage of vaccination and case fatality rate. In order to make the comparison over time, we aggregated the CFR data and vaccination rates over each month. This means that our basic unit of analysis is a country in a given month, with data on the CFR (deaths/cases) and average vaccination rate (people fully vaccinated per 100 people) over each month. The following boxplot shows the case fatality rate over different levels of vaccination.

```{r}
p_vac_cfr_box <- df %>% 
  filter(!(is.na(WHO_region))) %>% 
  ggplot(aes(region_name,cfr,col=vaccinated_level))+
  geom_boxplot()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.1)
  )+
  coord_flip()+
  # theme(axis.text.x = element_text(angle =-45,vjust=-0.5))+
  labs(col="Percentage of People \n Fully Vaccinated [%]",
       x="WHO Region",
       y="Case Fatality Rate COVID-19 [%]",
       caption="Each point represents a country summary statistics each month")
p_vac_cfr_box
```

We observe for each region a clear reduction in the CFR for COVID-19, both in the average value and in the variation across countries in each month. This reduction occurs in higher intensity with vaccination rates above 50%. We also observe that some regions are left unvaccinated, like Africa.\newline

This figure seems to support our main hypothesis of reduction of CFR in countris with higher vaccination rates. Let's construct statistical model to test this hypothesis formally.

## Inferential analysis 

A model including the vaccination level categorical variable is fitted. The following table shows the fitted coefficients for the vaccination level, along with the confidence intervals at 95% level. Diagnostics of this model are presented in the appendix section.

```{r}
# Model
df_model <- df %>% 
  select(deaths,cfr,cases,vaccinated,vaccinated_level,location,month) %>% 
  na.omit()

# ## Poisson model
# model1 <- glm(deaths~vaccinated+location+month+offset(log(cases)), 
#               data = df_model,
#               family = "poisson") 
# summary(model1)
# # vaccinated variable
# exp(model1$coefficients[2])
# exp(confint(model1,"vaccinated", level=0.95))
# 
# model2 <- glm(deaths~vaccinated_level+location+month+offset(log(cases)), 
#               data = df_model,
#               family = "poisson") 
# summary(model2)
# # vaccinated variable
# exp(model2$coefficients[2:4])
# exp(confint(model2,2:4, level=0.95))


## Negative Binomial model
# model.nb <- MASS::glm.nb(deaths~vaccinated+location+month+offset(log(cases)), 
#               data = df_model) 
# summary(model.nb)
# exp(model.nb$coefficients[2])
# exp(confint(model.nb,"vaccinated", level=0.95))

# Model with categorical vaccinated level
model.nb2 <- MASS::glm.nb(deaths~vaccinated_level+
                            location+month+offset(log(cases)), 
              data = df_model) 
# summary(model.nb2)
point_vac <- exp(model.nb2$coefficients[2:4])
ci_vac <- exp(confint(model.nb2,2:4, level=0.95))
```

```{r}
estimates <- data.frame(mid=point_vac,
                        lower_bound=ci_vac[,1],
                        upper_bound=ci_vac[,2])
names(estimates) <- c("Estimated Coefficient",
                      "Lower Bound C.I. 95%",
                      "Upper Bound C.I. 95%")

estimates <- estimates %>% 
  rownames_to_column() %>% 
  rename(Variable=rowname) %>% 
  mutate(Variable=str_replace(Variable,"vaccinated_level",
                              "Vaccination Level: "))


estimates %>%
  flextable() %>% 
  autofit() %>% 
  colformat_double(digits=2) %>% 
  set_caption("Estimated coefficients: Vaccination Level")

estimates %>% 
  mutate(Variable=str_remove(Variable,"Vaccination Level: ")) %>% 
  ggplot(aes(Variable, `Estimated Coefficient`))+
  geom_point(col="red")+
  geom_errorbar(aes(ymin=`Lower Bound C.I. 95%`,
                    ymax=`Upper Bound C.I. 95%`))+
  coord_flip()+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(x="Vaccination Level",y="Estimated Coefficients: Vaccination Level")
```

The estimated coefficients represent the relative change with respect to the reference case (Vaccination level between 0% and 25%). We can see important reduction associated with higher vaccination levels, meaning that countries with higher vaccination levels have a lower CFR, an it is an increasing relationship. Also, as the C.I. don't cross the reference line at 1, we can reject the null hypothesis of no effect of vaccination level on CFR at 95% level. \newline

Let's present also a summary of the other fitted coefficients estimated for each country and for each month:

```{r}
location_coefficients <- data.frame(coef=exp(model.nb2$coefficients)) %>% 
  rownames_to_column() %>% 
  filter(str_detect(rowname,"location")) %>% 
  mutate(location=str_remove(rowname,"location"))

# Plot with WHO region
country_region <- df %>% 
  group_by(region_name,location) %>% tally() %>% ungroup()

location_coefficients %>% 
  left_join(country_region) %>% 
  ggplot(aes(region_name,coef,col=region_name))+
  geom_jitter(alpha=.5)+
  geom_boxplot()+
  geom_hline(yintercept = 1, linetype="dashed")+
  coord_flip()+
  guides(col=F)+
  labs(x="WHO Region",col="",y="Estimated Coefficient: Country")
```

```{r}
size_coef <- length(model.nb2$coefficients)

# get coefficients for month
point_month <- exp(model.nb2$coefficients[(size_coef-13):(size_coef)])
ci_month <- exp(confint(model.nb2,(size_coef-13):(size_coef), level=0.95))

estimates_month <- data.frame(mid=point_month,
                        lower_bound=ci_month[,1],
                        upper_bound=ci_month[,2])

names(estimates_month) <- c("Estimated Coefficient",
                      "Lower Bound C.I. 95%",
                      "Upper Bound C.I. 95%")

estimates_month %>% 
  rownames_to_column() %>% 
  mutate(rowname=str_remove(rowname,"month"),
         month=factor(rowname, levels=rev(month_levels))) %>%  
  ggplot(aes(month, `Estimated Coefficient`))+
  geom_point(col="red")+
  geom_errorbar(aes(ymin=`Lower Bound C.I. 95%`,
                    ymax=`Upper Bound C.I. 95%`))+
  coord_flip()+
  geom_hline(yintercept = 1, linetype="dashed")+
  labs(x="",y="Estimated Coefficients: Month. Reference variable: 2020-12")
```

Overall we observe some interesting patterns:

- Countries in Europe have a much lower relative risk compared to other countries.
- We do observe a reduction in time of the relative risk, with the presence of some peaks probably associated with new variants of COVID-19.

## Sensitivity analysis 

**To Do**. See methods section for the scenarios to be analyzed.

# Discussion 

**Proposed Outline**:
- A brief recap of this project. 
- Findings in the inferential analysis
- Suggestions for future research and/or policy making given your findings. 
- Caveats of the current analysis.


The model suffers from some inherent problems. Here are the problems and a possible workaround:

- **Spatial correlation**: Perhaps I can add the variable region in the data set to control for continental effects on COVID-19, under the assumption that countries in the same region share more immigration, resulting in a jointly COVID-19 spread.
- **Delay due to detection**: There is an approximate two weeks difference between detected cases and deaths, due to evolution of the disease. The reason I am grouping whole months is to capture all deaths and cases over a longer period of time, to obtain a more accurate estimate of the case fatality rate. 
- **Time series autocorrelation**: I would need to test for the presence of autocorrelation in the panel data, and if present I will need to correct them, perhaps with the addition of the case mortality rate for the previous period (dynamic model).
- **Different demographics or characteristics across countries**: The dummy variable per country added to the model should control for each country individual characteristics, under the assumption that these traits haven't suffered major changes in the time period analyzed (2021-12 to 2022-2).
- **Observational unit**: The data used correspond to monthly summaries for each country, so all inference about vaccines effectiveness in reducing the CFR for COVID-19 are only valid for this unit of analysis. This study cannot infer anything about the effectiveness of vaccines at the individual level. 

# Conclusion

**Outline**:

- Main results from the model
- Implications of the results
- Limitations
- Suggestions for future studies

# Acknowledgement {-}

I acknowledge the instructor Professor Shizhe Chen and his materials for statistical methods of research. i also acknowledge the following classmates for their valuable feedback and comments during the project development: Yinan Cheng, Shuyu Guo and Kyung Jin Lee.

# Reference {-}

- - Course Notes STA207 UC Davis Winter Quarter 2022. Professor Shizhe Chen. Chapter 4 - Analysis of Variance. 

# Session info {-}

<span style='color:blue'>
Report information of your `R` session for reproducibility. 
</span> 


```{r}
sessionInfo()
```



# Appendix - Additional Analysis/Figures

## Distribution of the outcome variable

The following figure shows the distribution of the CFR per WHO region, with no transformation and with a logarithmic transformation. We can see that applying a logarithmic transformation on the outcome variable help the distribution become more Normally distributed.

```{r}
df %>% 
  mutate(log_cfr=log(cfr)) %>% 
  pivot_longer(c(cfr, log_cfr), names_to = "key", values_to = "value") %>% 
  ggplot(aes(value,fill=region_name))+
  geom_density(alpha=.5)+
  facet_wrap(region_name~key,scales = "free")+
  labs(y="Density",x="Case Fatality Rate COVID-19 [%]",
       caption = "Cumulated cases and deaths for the period December 2020 to February 2022")
```

## Density of Vaccination status

The following figure shows the distribution of the vaccination status per coutnry, showing that within each WHO region we observe a bi-modal distribution. Except for Africa region, there are two groups of countries: ones with high vaccionation rate and ones with lower vaccination rate.

```{r}
# density of vaccination
df %>% 
  filter(month=="2022-2") %>% #February 2022 
  ggplot(aes(vaccinated,fill=region_name))+
  geom_density(alpha=.5)+
  facet_wrap(~region_name,scales = "free")+
  labs(y="Density",x="People Fully Vaccinated per 100 people",
       caption = "Vaccination status at February 2022")
```

# Appendix - Model Diagnostics


```{r}
# Negative Binomial - Vaccination numeric
# par(mfrow = c(2, 2))
# plot(model.nb)
# par(mfrow = c(1,1))
```

## Negative Binomial Model - Vaccination as categorical variable

```{r}
# Negative Binomial Model - Vaccination as categorical variable
par(mfrow = c(2, 2))
plot(model.nb2)
par(mfrow = c(1,1))

# autoplot(model.nb2) 
```

In the diagnostics plot we can observe:

- Equal variance across model residuals, with the presence of some potential outliers values.
- Some observations seems to have high leverage, but below 0.5 Cook's distance. An additional analysis on a model without these observations may be needed.
- Residuals distribution seems to deviate from the Normality assumption, with a heavily right-skewed distribution. This could be due to the presence of observations with high values for CFR. This may required additional treatment in the model.

# Appendix - R Code used {-}

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```

